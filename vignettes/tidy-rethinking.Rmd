---
title: "Extracting and visualizing tidy draws from rethinking models"
author: "Matthew Kay"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    df_print: kable
vignette: >
  %\VignetteIndexEntry{Extracting and visualizing tidy draws from rethinking models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
<style type="text/css">
.kable-table table {
  margin-left: 0;
}
img {
  border: none;
}
</style>

```{r chunk_options, include=FALSE}
knitr::opts_chunk$set(
  eval = if (isTRUE(exists("params"))) params$EVAL else FALSE
)
if (capabilities("cairo")) {
  knitr::opts_chunk$set(
    dev.args = list(png = list(type = "cairo"))
  )
}
```

## Introduction
  
This vignette describes how to use the `tidybayes.rethinking` and `tidybayes` packages to extract [tidy](http://dx.doi.org/10.18637/jss.v059.i10) data frames of draws from posterior distributions of model variables, fits, and predictions from models fit in Richard McElreath's [`rethinking` package](https://github.com/rmcelreath/rethinking), the companion to [Statistical Rethinking](https://xcelab.net/rm/statistical-rethinking/). 

Because the `rethinking` package is not on CRAN, the code necessary to support that package is kept here, in the `tidybayes.rethinking` package. For a more general introduction to `tidybayes` and its use on general-purpose Bayesian modeling languages (like Stan and JAGS), see <code>[vignette("tidybayes", package = "tidybayes")](http://mjskay.github.io/tidybayes/articles/tidybayes.html)</code>.

## Setup
  
The following libraries are required to run this vignette:
  
```{r setup, message = FALSE, warning = FALSE}
library(magrittr)
library(dplyr)
library(purrr)
library(forcats)
library(tidyr)
library(modelr)
library(tidybayes)
library(tidybayes.rethinking)
library(ggplot2)
library(ggstance)
library(cowplot)
library(rstan)
library(rethinking)
library(ggrepel)
library(RColorBrewer)
library(gganimate)

theme_set(theme_tidybayes() + panel_border())
```

These options help Stan run faster:

```{r, eval=FALSE}
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

## Example dataset

To demonstrate `tidybayes`, we will use a simple dataset with 10 observations from 5 conditions each:

```{r}
set.seed(5)
n = 10
n_condition = 5
ABC =
  tibble(
    condition = factor(rep(c("A","B","C","D","E"), n)),
    response = rnorm(n * 5, c(0,1,2,1,-1), 0.5)
  )
```

A snapshot of the data looks like this:

```{r}
head(ABC, 10)
```

This is a typical tidy format data frame: one observation per row. Graphically:

```{r fig.width = tiny_width, fig.height = tiny_height}
ABC %>%
  ggplot(aes(y = condition, x = response)) +
  geom_point()
```

## Model

Let's fit a linear regression model using a quadratic approximation (`quap`):

```{r m_quap, cache = TRUE}
m_quap <- quap(alist(
    response ~ dnorm(mu, sigma),
    mu <- intercept[condition],
    intercept[condition] ~ dnorm(0, 10),
    sigma ~ dexp(1)
  ), 
  data = ABC
)
```

The results look like this:

```{r}
m_quap %>%
  tidy_draws()
```


```{r m_quap, cache = TRUE}
m_ulam <- ulam(alist(
    response ~ normal(mu, sigma),
    mu <- intercept[condition],
    intercept[condition] ~ normal(0, 10),
    sigma ~ exponential(1)
  ), 
  data = ABC,
  chains = 2
)
```
